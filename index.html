<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>亚洲集团 数据库（前端版）</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        body { background: linear-gradient(135deg, #18181c 0%, #444 100%); color: #e0e0e0; font-family: Arial, sans-serif; padding: 20px; }
        .tabs { display: flex; margin-bottom: 20px; }
        .tab { padding: 12px 28px; cursor: pointer; background: #232526; border: 1px solid #333; border-radius: 12px 12px 0 0; margin-right: 5px; color: #b0b0b0; font-weight: 500; position: relative;}
        .tab.active { background: linear-gradient(90deg, #00e676 0%, #1de9b6 100%); color: #232526; border-bottom: 1px solid #232526; }
        .tab-content { display: none; padding: 28px 24px 24px 24px; border: 1px solid #333; border-top: none; border-radius: 0 0 12px 12px; background: rgba(30,32,34,0.98); }
        .tab-content.active { display: block; }
        textarea { width: 100%; min-height: 140px; border-radius: 12px; border: 1.5px solid #333; background: linear-gradient(135deg, #232526 0%, #414345 100%); color: #fff; font-size: 16px; padding: 16px; margin-bottom: 18px; }
        button { padding: 10px 22px; background: linear-gradient(90deg, #232526 0%, #414345 100%); color: #fff; border: none; border-radius: 8px; cursor: pointer; font-size: 15px; }
        button:hover, button:focus { background: linear-gradient(90deg, #00e676 0%, #1de9b6 100%); color: #232526; }
        .card-group { display: flex; gap: 18px; margin: 18px 0 0 0; flex-wrap: wrap; }
        .card-poultry { background: linear-gradient(90deg,#43e97b 0%,#38f9d7 100%); color: #232526; border-radius: 10px; padding: 14px 24px; font-weight: bold; min-width: 120px; }
        .card-beast { background: linear-gradient(90deg,#fd746c 0%,#ff9068 100%); color: #232526; border-radius: 10px; padding: 14px 24px; font-weight: bold; min-width: 120px; }
        .card-bose-red { background: linear-gradient(90deg,#ff5858 0%,#f09819 100%); color: #fff; border-radius: 10px; padding: 14px 24px; font-weight: bold; min-width: 120px; }
        .card-bose-blue { background: linear-gradient(90deg,#2193b0 0%,#6dd5ed 100%); color: #fff; border-radius: 10px; padding: 14px 24px; font-weight: bold; min-width: 120px; }
        .card-bose-green { background: linear-gradient(90deg,#56ab2f 0%,#a8e063 100%); color: #232526; border-radius: 10px; padding: 14px 24px; font-weight: bold; min-width: 120px; }
        .stat-float-bar {
            background: linear-gradient(90deg, #232526 0%, #43e97b 100%);
            color: #fff;
            border-radius: 14px;
            box-shadow: 0 4px 24px #000a;
            padding: 18px 24px 14px 24px;
            margin: 24px 0 18px 0;
            position: relative;
            z-index: 10;
            transition: box-shadow 0.2s;
        }
        .save-btn-green {
            background: linear-gradient(90deg,#00e676 0%,#1de9b6 100%) !important;
            color: #232526 !important;
            font-weight: bold;
        }
        .stat-float-bar:hover {
            box-shadow: 0 8px 32px #00e67699, 0 4px 24px #000a;
        }
        .stat-float-title {
            color: #ffd700;
            font-weight: bold;
            font-size: 1.1em;
            margin-bottom: 8px;
            letter-spacing: 1px;
        }
        .user-data-list {
            margin-top: 10px;
            max-width: 340px;
            margin-left: auto;
            margin-right: auto;
        }
        .user-data-item {
            background: linear-gradient(90deg, #181c18 0%, #38f9d7 100%);
            color: #e0ffe0;
            border-radius: 6px;
            margin-bottom: 6px;
            padding: 4px 6px 2px 6px;
            box-shadow: 0 1px 4px #0003;
            position: relative;
            font-size: 13px;
            min-height: 28px;
            max-width: 260px;
            margin-left: auto;
            margin-right: auto;
            cursor: pointer;
            display: flex;
            align-items: flex-start;
            transition: box-shadow 0.15s, border 0.15s;
            border: 1.5px solid transparent;
        }
        .user-data-item.checked {
            border: 1.5px solid #00e676;
            box-shadow: 0 2px 10px #00e67633;
        }
        .user-data-checkbox {
            margin-top: 4px;
            margin-right: 6px;
            accent-color: #00e676;
            cursor: pointer;
            flex-shrink: 0;
            transform: scale(1.1);
            pointer-events: none;
        }
        .user-data-content { flex: 1; white-space: pre-wrap; font-family: inherit; }
        .user-data-title { color: #00e676; font-weight: bold; margin-bottom: 2px; font-size: 14px; }
        @media (max-width: 600px) {
            .card-group { flex-direction: column; gap: 12px; }
            .tab-content { padding: 12px 6px 12px 6px; }
            .tab { padding: 10px 10px; }
            button { width: 100%; }
            .stat-float-bar { padding: 12px 8px 10px 8px; }
            .user-data-list {
                max-width: 100vw;
                padding-left: 0;
                padding-right: 0;
            }
            .user-data-item {
                max-width: 95vw;
                min-width: 0;
                font-size: 12px;
                padding: 6px 2px 4px 2px;
            }
        }
        #userIntersectStat {
            display:none;
            margin-top:18px;
            padding:10px 6px 8px 6px;
            background:linear-gradient(90deg,#181c18 0%,#38f9d7 100%);
            border-radius:8px;
            max-width:340px;
            margin-left:auto;
            margin-right:auto;
            color:#00e676;
            font-size:14px;
        }
        #groupSaveBox {
            margin-top:18px;
            max-width:340px;
            margin-left:auto;
            margin-right:auto;
        }
        #groupSaveMsg {
            color:#00e676;
            margin-top:6px;
            font-size:13px;
        }
        #intersectStatResult {
            margin-top:18px;
            padding:10px 6px 8px 6px;
            background:linear-gradient(90deg,#181c18 0%,#38f9d7 100%);
            border-radius:8px;
            max-width:340px;
            margin-left:auto;
            margin-right:auto;
            color:#00e676;
            font-size:14px;
        }
        #unionStatResult {
            margin-top:18px;
            padding:10px 6px 8px 6px;
            background:linear-gradient(90deg,#181c18 0%,#38f9d7 100%);
            border-radius:8px;
            max-width:340px;
            margin-left:auto;
            margin-right:auto;
            color:#00e676;
            font-size:14px;
        }
        .intersection-group {
            margin-bottom: 18px;
        }
        .number-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 5px;
            margin-top: 10px;
        }
        .number-cell {
            padding: 6px 0;
            text-align: center;
            background-color: #fffae0;
            border-radius: 3px;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 8px;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 6px;
            text-align: center;
        }
        th {
            background-color: #232526;
            color: #ffd700;
        }
        #backToTopBtn {
            display:none;
            position:fixed;
            right:18px;
            bottom:28px;
            z-index:999;
            background:linear-gradient(90deg,#00e676 0%,#1de9b6 100%);
            color:#232526;
            font-weight:bold;
            border:none;
            border-radius:50%;
            width:48px;
            height:48px;
            font-size:22px;
            box-shadow:0 2px 12px #0007;
            cursor:pointer;
        }
        .group-btns { display: flex; gap: 12px; margin-bottom: 16px; }
        .group-btn {
            padding: 8px 18px;
            border-radius: 8px;
            border: none;
            font-size: 15px;
            font-weight: bold;
            cursor: pointer;
            background: #444;
            color: #bbb;
            transition: background 0.2s, color 0.2s;
        }
        .group-btn.selected {
            background: linear-gradient(90deg,#00e676 0%,#1de9b6 100%);
            color: #232526;
        }
        .group-btn:disabled {
            background: #222;
            color: #666;
            cursor: not-allowed;
            opacity: 0.7;
            border: 1px solid #444;
        }
        .param-box {
            margin-bottom: 12px;
            background: #232526;
            border-radius: 8px;
            padding: 10px 16px;
            color: #ffd700;
        }
        .param-box input[type=number] {
            width: 60px;
            border-radius: 6px;
            border: 1px solid #444;
            padding: 2px 6px;
            font-size: 15px;
        }
        .save-param-btn {
            margin-left: 12px;
            padding: 4px 16px;
            border-radius: 6px;
            background: linear-gradient(90deg,#00e676 0%,#1de9b6 100%);
            color: #232526;
            font-weight: bold;
            border: none;
            cursor: pointer;
        }
        .progress-bar-bg {
            width: 100%;
            height: 18px;
            background: #333;
            border-radius: 8px;
            margin: 18px 0 8px 0;
            overflow: hidden;
            position: relative;
        }
        .progress-bar-inner {
            height: 100%;
            background: linear-gradient(90deg,#ff4c4c 0%,#00e676 100%);
            width: 0%;
            transition: width 0.2s, background 0.2s;
        }
        .progress-bar-percent {
            position: absolute;
            left: 50%;
            top: 0;
            transform: translateX(-50%);
            color: #fff;
            font-weight: bold;
            font-size: 14px;
            line-height: 18px;
            z-index: 2;
            pointer-events: none;
        }
        .copy-btn {
            margin-left: 8px;
            padding: 2px 10px;
            border-radius: 5px;
            background: #ffd700;
            color: #232526;
            font-size: 13px;
            border: none;
            cursor: pointer;
        }
        .copy-btn.copied {
            background: #00e676;
            color: #fff;
        }
        .group-tag {
            display: inline-block;
            font-size: 11px;
            padding: 2px 6px;
            border-radius: 4px;
            margin: 2px 2px 0 0;
        }
        .group-tag-red {
            background: #ff5858;
            color: white;
        }
        .group-tag-purple {
            background: #a742f5;
            color: white;
        }
        .group-tag-green {
            background: #56ab2f;
            color: white;
        }
        .group-tag-yellow {
            background: #ffd700;
            color: #232526;
        }
        .filter-panel {
            background: #232526;
            border-radius: 10px;
            padding: 12px 18px 8px 18px;
            margin-bottom: 18px;
            box-shadow: 0 2px 12px #0005;
            display: flex;
            flex-wrap: wrap;
            gap: 18px 32px;
            align-items: center;
            justify-content: center;
        }
        .filter-panel label {
            margin-right: 8px;
            font-size: 15px;
            font-weight: bold;
            color: #ffd700;
        }
        .filter-panel .filter-group {
            margin-bottom: 6px;
        }
        .filter-panel input[type=checkbox] {
            accent-color: #00e676;
            margin-right: 2px;
            transform: scale(1.1);
        }
      .gradient-title {
            font-size: 2.2em;
            font-weight: bold;
            text-align: center;
            letter-spacing: 2px;
            background: linear-gradient(270deg, #ff2a2a, #4fc3f7, #ff2a2a);
            background-size: 200% 200%;
            color: transparent;
            background-clip: text;
            -webkit-background-clip: text;
            animation: gradientMove 3s linear infinite;
        }
        @keyframes gradientMove {
            0% { background-position: 0% 50%; }
            100% { background-position: 100% 50%; }
        }
    </style>
</head>
<body>
   <h2 class="gradient-title">亚洲集团 数据库（前端版）</h2>
<!-- 全局筛选面板按钮 -->
<div id="filterPanelWrapper" style="margin-bottom:18px;">
  <div style="display:flex;align-items:center;justify-content:space-between;">
    <span style="font-size:17px;color:#ffd700;font-weight:bold;">筛选条件</span>
    <button id="filterPanelToggleBtn" onclick="showFilterPanel()" style="padding:2px 14px;border-radius:6px;background:#232526;color:#ffd700;font-weight:bold;font-size:14px;border:1px solid #444;">展开</button>
  </div>
</div>
<!-- 全局筛选面板浮层 -->
<div id="globalFilterPanelModal" style="display:none;position:fixed;top:0;left:0;width:100vw;height:100vh;z-index:999;background:rgba(0,0,0,0.25);">
  <div style="position:absolute;top:80px;left:50%;transform:translateX(-50%);background:#232526;padding:24px 32px;border-radius:12px;min-width:340px;box-shadow:0 8px 32px #000;">
    <div style="display:flex;justify-content:space-between;align-items:center;">
      <span style="font-size:18px;color:#ffd700;font-weight:bold;">筛选条件</span>
      <button onclick="hideFilterPanel()" style="background:none;border:none;font-size:20px;color:#ffd700;cursor:pointer;">×</button>
    </div>
    <div class="filter-panel" id="globalFilterPanel" style="margin-top:18px;"></div>
  </div>
</div>
<div class="tabs">
    <div class="tab active" onclick="openTab('bigdata')">大数据解析</div>
    <div class="tab" onclick="openTab('userdata')">用户数据</div>
    <div class="tab" onclick="openTab('intersectstat')">交集统计</div>
    <div class="tab" onclick="openTab('unionstat')">并集统计</div>
</div>
    
<!-- 大数据解析页面 -->
<div id="bigdata" class="tab-content active">
    <div style="font-size:1.3em;color:#ffd700;font-weight:bold;letter-spacing:2px;margin-bottom:10px;">大数据解析</div>
    <textarea id="bigDataInput" rows="6" placeholder="请粘贴所有用户数据（支持多种分隔符）" style="width:100%;margin-top:32px;border-radius:8px;padding:10px 12px;background:#232526;color:#fff;border:1px solid #444;"></textarea>
    <button id="resetBigDataInputBtn" style="margin-top:8px;padding:6px 18px;border-radius:8px;background:#ff4c4c;color:#fff;font-weight:bold;">重置输入框</button>
    <div style="margin:8px 0 0 0;color:#ffd700;font-weight:bold;">用户数：<span id="bigDataUserCount">0</span></div>
    <button id="analyzeBtn" style="margin-top:10px;padding:8px 22px;border-radius:8px;background:linear-gradient(90deg,#00e676 0%,#1de9b6 100%);color:#232526;font-weight:bold;">统计</button>
    <div id="bigDataResult" style="margin-top:14px;"></div>
</div>
    
<!-- 用户数据页面 -->
<div id="userdata" class="tab-content">
    <!-- 悬浮到底部按钮，右下角，手机端同样适用 -->
    <button id="scrollToBottomBtn" onclick="scrollToBottom()" style="
      display:none;
      position:fixed;
      right:18px;
      bottom:88px;
      z-index:999;
      background:linear-gradient(90deg,#ffd700 0%,#ffec80 100%);
      color:#232526;
      font-weight:bold;
      border:none;
      border-radius:50%;
      width:48px;
      height:48px;
      font-size:28px;
      box-shadow:0 2px 12px #0007;
      cursor:pointer;
      align-items:center;
      justify-content:center;
    ">↓</button>
    <div style="font-size:1.3em;color:#ffd700;font-weight:bold;letter-spacing:2px;margin-bottom:10px;">用户数据</div>
    <div style="color:#ffd700;font-weight:bold;margin-bottom:8px;">
        用户总数：<span id="userDataTotal">0</span>
        &nbsp;&nbsp;已勾选：<span id="userDataChecked">0</span>
        &nbsp;&nbsp;
        <button id="selectAllBtn" onclick="selectAllUsers()" style="padding:4px 14px;border-radius:6px;background:linear-gradient(90deg,#00e676 0%,#1de9b6 100%);color:#232526;font-weight:bold;font-size:13px;">一键全选</button>
    </div>
    <div id="userDataPanel" class="user-data-list"></div>
    <div id="userIntersectStat"></div>
    <div id="groupSaveBox">
        <div style="color:#ffd700;font-weight:bold;margin-bottom:6px;">保存勾选到分组</div>
        <select id="saveGroupSelect" style="padding:4px 10px;border-radius:6px;font-size:14px;">
            <option value="group1">1码4码8码12码组</option>
            <option value="group2">4码8码12码组</option>
            <option value="group3">8码12码组</option>
        </select>
        <button onclick="saveCheckedToGroup()" style="margin-left:10px;padding:4px 16px;border-radius:6px;background:linear-gradient(90deg,#00e676 0%,#1de9b6 100%);color:#232526;font-weight:bold;">保存</button>
        <button onclick="clearGroupData()" style="margin-left:10px;padding:4px 16px;border-radius:6px;background:#ff4c4c;color:#fff;font-weight:bold;">清空分组数据</button>
        <div id="groupSaveMsg"></div>
    </div>
</div>

<!-- 交集统计页面（注意：现在是独立的，不在用户数据页面里面！） -->
<div id="intersectstat" class="tab-content">
    <div style="font-size:1.3em;color:#ffd700;font-weight:bold;letter-spacing:2px;margin-bottom:10px;">交集统计</div>
    <div>
    <div style="color:#ffd700;font-weight:bold;margin-bottom:8px;">请选择分组进行交集统计</div>
    <select id="intersectGroupSelect" style="padding:4px 10px;border-radius:6px;font-size:14px;">
        <option value="group1">1码4码8码12码组</option>
        <option value="group2">4码8码12码组</option>
        <option value="group3">8码12码组</option>
    </select>
    <button onclick="showIntersectStat()" style="margin-left:10px;padding:6px 18px;border-radius:8px;background:linear-gradient(90deg,#00e676 0%,#1de9b6 100%);color:#232526;font-weight:bold;">统计交集</button>
    <!-- 三个独立保存按钮 -->
    <button id="saveBtn_group1" onclick="saveIntersectResultToLocal('group1')" style="margin-left:10px;padding:6px 18px;border-radius:8px;background:#444;color:#fff;font-weight:bold;">保存1码4码8码12码</button>
    <button id="saveBtn_group2" onclick="saveIntersectResultToLocal('group2')" style="margin-left:10px;padding:6px 18px;border-radius:8px;background:#444;color:#fff;font-weight:bold;">保存4码8码12码</button>
    <button id="saveBtn_group3" onclick="saveIntersectResultToLocal('group3')" style="margin-left:10px;padding:6px 18px;border-radius:8px;background:#444;color:#fff;font-weight:bold;">保存8码12码</button>
    <button onclick="clearIntersectGroupData()" style="margin-left:10px;padding:6px 18px;border-radius:8px;background:#ff4c4c;color:#fff;font-weight:bold;">清空交集</button>
    <span id="saveIntersectMsg" style="margin-left:10px;color:#ffd700;"></span>
</div>
<div id="intersectStatResult" style="margin-top:20px;"></div>
</div>

<!-- 并集统计页面 -->
<div id="unionstat" class="tab-content">
    <div style="font-size:1.3em;color:#ffd700;font-weight:bold;letter-spacing:2px;margin-bottom:10px;">并集统计</div>
    <div>
        <div style="color:#ffd700;font-weight:bold;margin-bottom:8px;">请选择交集保存的组进行并集分析</div>
        <div class="group-btns" id="unionGroupBtns">
            <button class="group-btn" id="unionBtn_group1" onclick="toggleUnionGroup('group1')">1码4码8码12码组</button>
            <button class="group-btn" id="unionBtn_group2" onclick="toggleUnionGroup('group2')">4码8码12码组</button>
            <button class="group-btn" id="unionBtn_group3" onclick="toggleUnionGroup('group3')">8码12码组</button>
        </div>
        
        <!-- 参数设置区域（改进后） -->
        <div id="unionParamBox" class="param-box" style="margin-top:15px;display:block;">
            <div style="margin-bottom:10px;color:#00e676;">请设置每组的最小/最大出现次数：</div>
            <div style="display:flex;flex-wrap:wrap;gap:15px;">
                <div class="param-group">
                    <div>1码4码8码12码组：</div>
                    <input type="number" id="unionParamMin_group1" placeholder="最小值" min="0" max="30" style="width:80px;">
                    <input type="number" id="unionParamMax_group1" placeholder="最大值" min="1" max="30" style="width:80px;">
                    <button onclick="saveUnionParam('group1')" style="margin-left:10px;">保存</button>
                    <span id="unionParamMsg_group1" style="margin-left:10px;color:#ff4c4c;"></span>
                </div>
                <div class="param-group">
                    <div>4码8码12码组：</div>
                    <input type="number" id="unionParamMin_group2" placeholder="最小值" min="0" max="30" style="width:80px;">
                    <input type="number" id="unionParamMax_group2" placeholder="最大值" min="1" max="30" style="width:80px;">
                    <button onclick="saveUnionParam('group2')" style="margin-left:10px;">保存</button>
                    <span id="unionParamMsg_group2" style="margin-left:10px;color:#ff4c4c;"></span>
                </div>
                <div class="param-group">
                    <div>8码12码组：</div>
                    <input type="number" id="unionParamMin_group3" placeholder="最小值" min="0" max="30" style="width:80px;">
                    <input type="number" id="unionParamMax_group3" placeholder="最大值" min="1" max="30" style="width:80px;">
                    <button onclick="saveUnionParam('group3')" style="margin-left:10px;">保存</button>
                    <span id="unionParamMsg_group3" style="margin-left:10px;color:#ff4c4c;"></span>
                </div>
            </div>
        </div>

        <!-- 按钮区域 -->
        <div style="margin-top:20px;display:flex;">
            <button id="unionAnalyzeBtn" onclick="startUnionAnalyze()" 
                    style="padding:8px 22px;border-radius:8px;background:linear-gradient(90deg,#00e676 0%,#1de9b6 100%);color:#232526;font-weight:bold;">
                并集分析
            </button>
            <button id="enhancedAnalyzeBtn" onclick="showEnhancedAnalysis()" 
                    style="margin-left:15px;padding:8px 22px;border-radius:8px;background:linear-gradient(135deg,#6a11cb,#2575fc);color:white;font-weight:bold;">
                高级分析
            </button>
        </div>
        
        <!-- 进度条 -->
        <div class="progress-bar-bg" id="unionProgressBar" style="margin-top:15px;display:none;">
            <div class="progress-bar-inner" id="unionProgressInner"></div>
            <span class="progress-bar-percent" id="unionProgressPercent">0%</span>
        </div>
    </div>
    
    <!-- 结果显示区域 -->
    <div id="unionStatResult" style="margin-top:20px;"></div>
</div>
    
<button id="backToTopBtn" onclick="scrollToTop()">↑</button>
<script>
// 常量定义
const sxList = ['鼠','牛','虎','兔','龙','蛇','马','羊','猴','鸡','狗','猪'];
const headList = ['0','1','2','3','4'];
const tailList = ['0','1','2','3','4','5','6','7','8','9'];
const poultryList = ['猪', '狗', '鸡', '羊', '马', '牛'];
const beastList = ['鼠', '蛇', '龙', '兔', '虎', '猴'];
const shengxiaoMap = {
    '鼠': [6,18,30,42],
    '牛': [5,17,29,41],
    '虎': [4,16,28,40],
    '兔': [3,15,27,39],
    '龙': [2,14,26,38],
    '蛇': [1,13,25,37,49],
    '马': [12,24,36,48],
    '羊': [11,23,35,47],
    '猴': [10,22,34,46],
    '鸡': [9,21,33,45],
    '狗': [8,20,32,44],
    '猪': [7,19,31,43]
};
const boseMap = {
    '01': '红', '02': '红', '07': '红', '08': '红', '12': '红', '13': '红', '18': '红', '19': '红', '23': '红', '24': '红', '29': '红', '30': '红', '34': '红', '35': '红', '40': '红', '45': '红', '46': '红',
    '03': '蓝', '04': '蓝', '09': '蓝', '10': '蓝', '14': '蓝', '15': '蓝', '20': '蓝', '25': '蓝', '26': '蓝', '31': '蓝', '36': '蓝', '37': '蓝', '41': '蓝', '42': '蓝', '47': '蓝', '48': '蓝',
    '05': '绿', '06': '绿', '11': '绿', '16': '绿', '17': '绿', '21': '绿', '22': '绿', '27': '绿', '28': '绿', '32': '绿', '33': '绿', '38': '绿', '39': '绿', '43': '绿', '44': '绿', '49': '绿'
};

// 全局变量
let activePage = 'bigdata';
let userRawDataList = [];
let savedGroups = { group1: [], group2: [], group3: [] };
let intersectSavedNums = { group1: [], group2: [], group3: [] };
let unionParam = { group1: {}, group2: {}, group3: {} };
let coreParam = JSON.parse(localStorage.getItem('nao_core_param') || 'null') || {
    sx: [...sxList],
    head: [...headList],
    tail: [...tailList]
};
let unionSelectedGroups = [];
let intersectStatReady = { group1: false, group2: false, group3: false };
// 渲染全局筛选面板
function renderGlobalFilterPanel() {
    let html = '';
    html += `<div class="filter-group"><label>生肖</label>`;
    sxList.forEach(sx => {
        html += `<input type="checkbox" class="filter-sx" value="${sx}" ${coreParam.sx.includes(sx)?'checked':''}>${sx}`;
    });
    html += `</div><div class="filter-group"><label>头数</label>`;
    headList.forEach(h => {
        html += `<input type="checkbox" class="filter-head" value="${h}" ${coreParam.head.includes(h)?'checked':''}>${h}`;
    });
    html += `</div><div class="filter-group"><label>尾数</label>`;
    tailList.forEach(t => {
        html += `<input type="checkbox" class="filter-tail" value="${t}" ${coreParam.tail.includes(t)?'checked':''}>${t}`;
    });
    html += `</div>`;
    document.getElementById('globalFilterPanel').innerHTML = html;
    document.querySelectorAll('.filter-sx,.filter-head,.filter-tail').forEach(el=>{
        el.onchange = updateCoreParamFromUI;
    });
}

// 新增：渲染并集筛选面板
function renderUnionFilterPanel() {
    let html = '';
    html += `<div class="filter-group"><label>生肖</label>`;
    sxList.forEach(sx => {
        html += `<input type="checkbox" class="union-filter-sx" value="${sx}" ${coreParam.sx.includes(sx)?'checked':''}>${sx}`;
    });
    html += `</div><div class="filter-group"><label>头数</label>`;
    headList.forEach(h => {
        html += `<input type="checkbox" class="union-filter-head" value="${h}" ${coreParam.head.includes(h)?'checked':''}>${h}`;
    });
    html += `</div><div class="filter-group"><label>尾数</label>`;
    tailList.forEach(t => {
        html += `<input type="checkbox" class="union-filter-tail" value="${t}" ${coreParam.tail.includes(t)?'checked':''}>${t}`;
    });
    html += `</div>`;
    document.getElementById('unionFilterPanel').innerHTML = html;
    
    document.querySelectorAll('.union-filter-sx, .union-filter-head, .union-filter-tail').forEach(el => {
        el.onchange = updateCoreParamFromUnionFilter;
    });
}

// 从UI更新核心参数
function updateCoreParamFromUI() {
    let sx = Array.from(document.querySelectorAll('.filter-sx:checked')).map(x=>x.value);
    let head = Array.from(document.querySelectorAll('.filter-head:checked')).map(x=>x.value);
    let tail = Array.from(document.querySelectorAll('.filter-tail:checked')).map(x=>x.value);
    coreParam = { sx, head, tail };
    localStorage.setItem('nao_core_param', JSON.stringify(coreParam));
    analyzeBigData && analyzeBigData();
    syncUserDataPanel && syncUserDataPanel();
    if(document.getElementById('intersectStatResult')) showIntersectStat && showIntersectStat();
    if(document.getElementById('unionStatResult')) showUnionStat && showUnionStat();
    
    // 同步并集筛选面板
    renderUnionFilterPanel();
}

// 新增：从并集筛选面板更新核心参数
function updateCoreParamFromUnionFilter() {
    let sx = Array.from(document.querySelectorAll('.union-filter-sx:checked')).map(x => x.value);
    let head = Array.from(document.querySelectorAll('.union-filter-head:checked')).map(x => x.value);
    let tail = Array.from(document.querySelectorAll('.union-filter-tail:checked')).map(x => x.value);
    
    coreParam = { sx, head, tail };
    localStorage.setItem('nao_core_param', JSON.stringify(coreParam));
    
    // 如果当前在并集统计页面，清空结果等待重新计算
    if (activePage === 'unionstat') {
        document.getElementById('unionStatResult').innerHTML = '';
    }
    
    // 如果当前在大数据解析页面，重新计算
    if (activePage === 'bigdata') {
        analyzeBigData();
    }
    
    // 同步全局筛选面板
    renderGlobalFilterPanel();
}

// 获取核心筛选条件
function getCoreFilter() {
    return coreParam;
}

// 数据存储相关函数
function saveGroupsToLocal() {
    localStorage.setItem('nao_saved_groups', JSON.stringify(savedGroups));
}
function saveIntersectNumsToLocal() {
    localStorage.setItem('nao_intersect_nums', JSON.stringify(intersectSavedNums));
}
function saveUnionParamToLocal() {
    localStorage.setItem('nao_union_param', JSON.stringify(unionParam));
}
function loadGroupsFromLocal() {
    try {
        let data = localStorage.getItem('nao_saved_groups');
        if (data) savedGroups = JSON.parse(data);
    } catch(e){}
    try {
        let data = localStorage.getItem('nao_intersect_nums');
        if (data) {
            let obj = JSON.parse(data);
            // 兼容老数据
            ['group1','group2','group3'].forEach(g=>{
                if(Array.isArray(obj[g])) {
                    obj[g] = { nums: obj[g], countMap: {} };
                }
            });
            intersectSavedNums = obj;
        }
    } catch(e){}
    try {
        let data = localStorage.getItem('nao_union_param');
        if (data) unionParam = JSON.parse(data);
    } catch(e){}
}
// 页面切换
function openTab(pageName) {
    document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
    document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
    document.getElementById(pageName).classList.add('active');
    document.querySelector(`.tab[onclick="openTab('${pageName}')"]`).classList.add('active');
    activePage = pageName;
    if(pageName === 'bigdata') updateBigDataUserCount();
    if(pageName === 'userdata') {
        syncUserDataPanel();
        document.getElementById('groupSaveMsg').textContent = "";
        document.getElementById('userIntersectStat').style.display = 'none';
    }
    if(pageName === 'intersectstat') {
        document.getElementById('intersectStatResult').innerHTML = '';
        updateIntersectGroupBtns();
    }
    if(pageName === 'unionstat') {
        unionSelectedGroups = [];
        syncUnionParamInputs();
        document.getElementById('unionProgressBar').style.display = 'none';
        document.getElementById('unionStatResult').innerHTML = '';
        updateUnionGroupBtns();
        renderUnionFilterPanel(); // 确保筛选条件同步
    }
}

// 用户数据相关函数
function syncUserDataPanel() {
    let input = document.getElementById('bigDataInput') ? document.getElementById('bigDataInput').value : '';
    let lines = input.split('\n');
    let users = {};
    let userOrder = [];
    let currentUser = null;
    let currentRaw = [];
    let userCodes = {};
    for (let i = 0; i < lines.length; i++) {
        let line = lines[i];
        let trimmed = line.trim();
        if (!trimmed) continue;
        let match = trimmed.match(/^https?:\/\/t\.me\/[^\/]+\/\d+\s+([^,，\[\] ]+)[,， ]/);
        if (match) {
            if (currentUser && currentRaw.length) {
                users[currentUser] = currentRaw.join('\n');
                userOrder.push(currentUser);
            }
            currentUser = match[1].trim();
            currentRaw = [line];
            userCodes[currentUser] = { code1: '', code4: '', code8: '', code12: '' };
            continue;
        }
        // 万能昵称行（支持各种表情、空格、符号、冒号等，且不是号码行/新澳行）
        if (
            !trimmed.includes('新澳') &&
            !trimmed.match(/^\d+[码:：]/) &&
            !trimmed.match(/^新澳\d+(期|码)/) &&
            trimmed.length > 0 &&
            !trimmed.match(/^\d+([.,，、|/\s-]\d+)*$/)
        ) {
            if (currentUser && currentRaw.length) {
                users[currentUser] = currentRaw.join('\n');
                userOrder.push(currentUser);
            }
            currentUser = trimmed.replace(/[:：\s]+$/, '').trim();
            currentRaw = [line];
            userCodes[currentUser] = { code1: '', code4: '', code8: '', code12: '' };
            continue;
        }
        let userCodeMatch = trimmed.match(/^([\u4e00-\u9fa5A-Za-z0-9_\-（）\(\)]+)[,， ]?\s*新澳(\d+)码[：:]\s*([\d\s.,，、|/]+)/);
        if (userCodeMatch) {
            if (currentUser && currentRaw.length) {
                users[currentUser] = currentRaw.join('\n');
                userOrder.push(currentUser);
            }
            currentUser = userCodeMatch[1].trim();
            currentRaw = [line];
            let codeType = userCodeMatch[2];
            let codeContent = userCodeMatch[3];
            userCodes[currentUser] = { code1: '', code4: '', code8: '', code12: '' };
            if (codeType === '1') userCodes[currentUser].code1 = codeContent;
            if (codeType === '4') userCodes[currentUser].code4 = codeContent;
            if (codeType === '8') userCodes[currentUser].code8 = codeContent;
            if (codeType === '12') userCodes[currentUser].code12 = codeContent;
            continue;
        }
        let codeMatch = trimmed.match(/新澳(\d+)码[：:]\s*([\d\s.,，、|/]+)/);
        if (codeMatch && codeMatch[1] && codeMatch[2]) {
            if (!currentUser) currentUser = '未知用户';
            if (!userCodes[currentUser]) userCodes[currentUser] = { code1: '', code4: '', code8: '', code12: '' };
            let codeType = codeMatch[1];
            let codeContent = codeMatch[2];
            if (codeType === '1') userCodes[currentUser].code1 = codeContent;
            if (codeType === '4') userCodes[currentUser].code4 = codeContent;
            if (codeType === '8') userCodes[currentUser].code8 = codeContent;
            if (codeType === '12') userCodes[currentUser].code12 = codeContent;
            currentRaw.push(line);
            continue;
        }
        let codeMatch2 = trimmed.match(/(\d+)码[：:]\s*([\d\s.,，、|/]+)/);
        if (codeMatch2 && codeMatch2[1] && codeMatch2[2]) {
            if (!currentUser) currentUser = '未知用户';
            if (!userCodes[currentUser]) userCodes[currentUser] = { code1: '', code4: '', code8: '', code12: '' };
            let codeType = codeMatch2[1];
            let codeContent = codeMatch2[2];
            if (codeType === '1') userCodes[currentUser].code1 = codeContent;
            if (codeType === '4') userCodes[currentUser].code4 = codeContent;
            if (codeType === '8') userCodes[currentUser].code8 = codeContent;
            if (codeType === '12') userCodes[currentUser].code12 = codeContent;
            currentRaw.push(line);
            continue;
        }
        if (currentUser) currentRaw.push(line);
    }
    if (currentUser && currentRaw.length) {
        users[currentUser] = currentRaw.join('\n');
        userOrder.push(currentUser);
    }
    userRawDataList = [];
    for (let name of userOrder) {
        userRawDataList.push({
            name,
            raw: users[name],
            code1: userCodes[name]?.code1 || '',
            code4: userCodes[name]?.code4 || '',
            code8: userCodes[name]?.code8 || '',
            code12: userCodes[name]?.code12 || ''
        });
    }
    let idxToGroup = {};
    userRawDataList.forEach((u, idx) => { idxToGroup[idx]=[]; });
    Object.entries(savedGroups).forEach(([group, arr])=>{
        arr.forEach(idx=>{
            if(!idxToGroup[idx]) idxToGroup[idx]=[];
            idxToGroup[idx].push(group);
        });
    });
    let html = '';
    userRawDataList.forEach((u, idx) => {
        let groupArr = idxToGroup[idx]||[];
        let tags = '';
        if(groupArr.length === 3) {
            tags += `<span class="group-tag group-tag-yellow">已保存到全部分组</span>`;
        } else {
            if(groupArr.includes('group1')) tags += `<span class="group-tag group-tag-red">已保存到1码4码8码12码数据库</span>`;
            if(groupArr.includes('group2')) tags += `<span class="group-tag group-tag-purple">已保存到4码8码12码数据库</span>`;
            if(groupArr.includes('group3')) tags += `<span class="group-tag group-tag-green">已保存到8码12码数据库</span>`;
        }
        html += `
        <div class="user-data-item" data-idx="${idx}" onclick="onUserDataItemClick(event,${idx})">
            <input type="checkbox" class="user-data-checkbox" data-idx="${idx}" onchange="onUserDataCheck(this)">
            <div class="user-data-content">
                <div class="user-data-title">${u.name}</div>
                <div>${u.raw.replace(/</g,'&lt;').replace(/>/g,'&gt;')}</div>
                <div>${tags}</div>
            </div>
        </div>`;
    });
    document.getElementById('userDataPanel').innerHTML = html;
    document.getElementById('userDataTotal').textContent = userRawDataList.length;
    updateUserDataChecked();
    updateUserDataCheckedStyle();
}

// 用户数据操作函数
function onUserDataItemClick(event, idx) {
    if (event.target.classList.contains('user-data-checkbox')) return;
    let checkbox = document.querySelector(`.user-data-checkbox[data-idx="${idx}"]`);
    checkbox.checked = !checkbox.checked;
    onUserDataCheck(checkbox);
}

function updateUserDataCheckedStyle() {
    document.querySelectorAll('.user-data-item').forEach(item => {
        let idx = item.getAttribute('data-idx');
        let checkbox = document.querySelector(`.user-data-checkbox[data-idx="${idx}"]`);
        if (checkbox.checked) {
            item.classList.add('checked');
        } else {
            item.classList.remove('checked');
        }
    });
}

function onUserDataCheck(checkbox) {
    updateUserDataChecked();
    updateUserDataCheckedStyle();
}

function updateUserDataChecked() {
    let checked = document.querySelectorAll('.user-data-checkbox:checked').length;
    document.getElementById('userDataChecked').textContent = checked;
}

let isAllSelected = false;
function selectAllUsers() {
    const checkboxes = document.querySelectorAll('.user-data-checkbox');
    isAllSelected = !isAllSelected;
    checkboxes.forEach(cb => { cb.checked = isAllSelected; });
    updateUserDataChecked();
    updateUserDataCheckedStyle();
    document.getElementById('selectAllBtn').textContent = isAllSelected ? '一键全不选' : '一键全选';
}

function saveCheckedToGroup() {
    let group = document.getElementById('saveGroupSelect').value;
    let checked = Array.from(document.querySelectorAll('.user-data-checkbox:checked')).map(box => parseInt(box.getAttribute('data-idx')));
    if (checked.length === 0) {
        alert("请先勾选要保存的用户！");
        document.getElementById('groupSaveMsg').textContent = "请先勾选要保存的用户！";
        return;
    }
    savedGroups[group] = Array.from(new Set(checked));
    saveGroupsToLocal();
    alert("保存成功！");
    document.getElementById('groupSaveMsg').innerHTML = `<span style="font-size:16px;">保存成功</span><br><span style="font-size:12px;color:#ffd700;">已提取到${getGroupName(group)}数据库</span>`;
    setTimeout(()=>{ document.getElementById('groupSaveMsg').textContent = ""; }, 2500);
    document.querySelectorAll('.user-data-checkbox').forEach(cb=>cb.checked=false);
    isAllSelected = false;
    document.getElementById('selectAllBtn').textContent = '一键全选';
    updateUserDataChecked();
    updateUserDataCheckedStyle();
    syncUserDataPanel();
    
    if(intersectSavedNums[group] && intersectSavedNums[group].length > 0) {
        intersectSavedNums[group] = [];
        saveIntersectNumsToLocal();
    }
}

function clearGroupData() {
    let group = prompt("请输入要清空的分组编号（1、2 或 3）：\n1=1码4码8码12码组\n2=4码8码12码组\n3=8码12码组");
    if (group !== '1' && group !== '2' && group !== '3') {
        alert("输入有误，未清空任何分组。");
        return;
    }
    let groupKey = group === '1' ? 'group1' : group === '2' ? 'group2' : 'group3';
    if (confirm("确定要清空该分组的数据吗？此操作不可恢复！")) {
        savedGroups[groupKey] = [];
        saveGroupsToLocal();
        intersectSavedNums[groupKey] = { nums: [], countMap: {} };
        saveIntersectNumsToLocal();
        document.getElementById('groupSaveMsg').innerHTML = `<span style="color:#00e676;">${getGroupName(groupKey)}分组数据已清空</span>`;
        setTimeout(()=>{ document.getElementById('groupSaveMsg').textContent = ""; }, 2000);
        syncUserDataPanel();
    }
}

function getGroupName(group) {
    if(group==='group1') return '1码4码8码12码';
    if(group==='group2') return '4码8码12码';
    if(group==='group3') return '8码12码';
    return '';
}

// 大数据解析相关函数
function updateBigDataUserCount() {
    let input = document.getElementById('bigDataInput').value.trim();
    let users = parseUserData(input, ['1','4','8','12']);
    let userCount = Object.keys(users).length;
    document.getElementById('bigDataUserCount').textContent = userCount;
}

function parseUserData(input, codeTypes) {
    const lines = input.split('\n');
    const users = {};
    let currentUser = null;
    for (const line of lines) {
        const trimmed = line.trim();
        if (!trimmed) continue;

        // t.me 链接昵称
        let match = trimmed.match(/^https?:\/\/t\.me\/[^\/]+\/\d+\s+([^,，\[\] ]+)[,， ]/);
        if (match) {
            currentUser = match[1].trim();
            if (!users[currentUser]) users[currentUser] = {};
            continue;
        }

        // 万能昵称行（支持各种表情、空格、符号、冒号等，且不是号码行/新澳行）
        if (
            !trimmed.includes('新澳') &&
            !trimmed.match(/^\d+[码:：]/) &&
            !trimmed.match(/^新澳\d+(期|码)/) &&
            trimmed.length > 0 &&
            !trimmed.match(/^\d+([.,，、|/\s-]\d+)*$/)
        ) {
            currentUser = trimmed.replace(/[:：\s]+$/, '').trim();
            if (!users[currentUser]) users[currentUser] = {};
            continue;
        }

        // ...后面保持不变...
        // ====== 新增万能昵称行识别 ======
        if (
            !trimmed.includes('新澳') &&
            !trimmed.match(/^\d+[码:：]/) &&
            !trimmed.match(/^新澳\d+(期|码)/) &&
            trimmed.length > 0 &&
            (
                !trimmed.match(/^[\u4e00-\u9fa5A-Za-z0-9_\-（）\(\)]+[,， ]?$/)
            )
        ) {
            currentUser = trimmed.replace(/[:：\s]+$/, '').trim();
            if (!users[currentUser]) users[currentUser] = {};
            continue;
        }
        // ====== 新增结束 ======
        let userCodeMatch = trimmed.match(/^([\u4e00-\u9fa5A-Za-z0-9_\-（）\(\)]+)[,， ]?\s*新澳(\d+)码[：:]\s*([\d\s.,，、|/]+)/);
        if (userCodeMatch) {
            currentUser = userCodeMatch[1].trim();
            const codeType = userCodeMatch[2];
            const numbersStr = userCodeMatch[3];
            if (!users[currentUser]) users[currentUser] = {};
            users[currentUser][codeType] = parseNumbers(numbersStr);
            continue;
        }
        let codeMatch = trimmed.match(/新澳(\d+)码[：:]\s*([\d\s.,，、|/]+)/);
        if (codeMatch && codeMatch[1] && codeMatch[2]) {
            const codeType = codeMatch[1];
            const numbersStr = codeMatch[2];
            if (!currentUser) currentUser = '未知用户';
            if (!users[currentUser]) users[currentUser] = {};
            users[currentUser][codeType] = parseNumbers(numbersStr);
            continue;
        }
        let codeMatch2 = trimmed.match(/(\d+)码[：:]\s*([\d\s.,，、|/]+)/);
        if (codeMatch2 && codeMatch2[1] && codeMatch2[2]) {
            const codeType = codeMatch2[1];
            const numbersStr = codeMatch2[2];
            if (!currentUser) currentUser = '未知用户';
            if (!users[currentUser]) users[currentUser] = {};
            users[currentUser][codeType] = parseNumbers(numbersStr);
            continue;
        }
    }
    return users;
}
function parseNumbers(str) {
    const numbers = str.split(/[.,\s，、\/|]/).filter(n => n.trim() !== '');
    return new Set(numbers.map(numStr => {
        const num = parseInt(numStr.replace(/[^\d]/g, ''), 10);
        return (num >= 1 && num <= 49) ? num.toString().padStart(2,'0') : null;
    }).filter(Boolean));
}

function analyzeBigData() {
    let input = document.getElementById('bigDataInput').value.trim();
    if (!input) {
        document.getElementById('bigDataResult').innerHTML = '<span style="color:#ff4c4c">请输入数据！</span>';
        return;
    }
    let users = parseUserData(input, ['1','4','8','12']);
    let allNums = [];
    Object.values(users).forEach(data=>{
        Object.values(data).forEach(set=>{
            allNums.push(...set);
        });
    });

    let core = getCoreFilter();
    if (core.sx.length === 0 || core.head.length === 0 || core.tail.length === 0) {
        let html = `
        <div class="card-group">
            <div class="card-poultry">家禽<br>0次<br>0%</div>
            <div class="card-beast">野兽<br>0次<br>0%</div>
        </div>
        <div class="card-group">
            <div class="card-bose-red">红波<br>0次<br>0%</div>
            <div class="card-bose-blue">蓝波<br>0次<br>0%</div>
            <div class="card-bose-green">绿波<br>0次<br>0%</div>
        </div>
        <div class="stat-float-bar">
            <div class="stat-float-title">号码统计（共 0 个）</div>
            <div style="color:#00e676;"></div>
        </div>
        <div class="stat-float-bar">
            <div class="stat-float-title">生肖统计（0 个）</div>
            <div style="color:#00e676;"></div>
        </div>
        <div class="stat-float-bar">
            <div class="stat-float-title">头数统计（0 个）</div>
            <div style="color:#00e676;"></div>
        </div>
        <div class="stat-float-bar">
            <div class="stat-float-title">尾数统计（0 个）</div>
            <div style="color:#00e676;"></div>
        </div>
        `;
        document.getElementById('bigDataResult').innerHTML = html;
        return;
    }

    let sxChecked = core.sx;
    let headChecked = core.head;
    let tailChecked = core.tail;

   let filteredNums = allNums.filter(num => {
    let inSx = sxChecked.some(sx => shengxiaoMap[sx].map(n=>n.toString().padStart(2,'0')).includes(num));
    if(!inSx) return false;
    let head = parseInt(num,10) >= 10 ? num[0] : '0';
    if(!headChecked.includes(head)) return false;
    let tail = num[num.length-1];
    if(!tailChecked.includes(tail)) return false;
    return true;
});

    let total = filteredNums.length;
    let numCount = {};
    filteredNums.forEach(num=>{
        numCount[num] = (numCount[num]||0)+1;
    });
    let numKeys = Object.keys(numCount).sort((a,b)=>a-b);
    let numGroup = {};
    numKeys.forEach(num=>{
        let cnt = numCount[num];
        if(!numGroup[cnt]) numGroup[cnt]=[];
        numGroup[cnt].push(num);
    });
    let numStat = Object.keys(numGroup).sort((a,b)=>b-a).map(cnt=>{
        let nums = numGroup[cnt].sort((a,b)=>a-b);
        return `〖${cnt}次〗${nums.join(' ')}（共计${nums.length}个）`;
    }).join('<br>');

    let poultryNums = [];
    let beastNums = [];
    filteredNums.forEach(num => {
        for(const sx of poultryList) {
            if(shengxiaoMap[sx].map(n=>n.toString().padStart(2,'0')).includes(num)) {
                poultryNums.push(num);
                return;
            }
        }
        for(const sx of beastList) {
            if(shengxiaoMap[sx].map(n=>n.toString().padStart(2,'0')).includes(num)) {
                beastNums.push(num);
                return;
            }
        }
    });
    let poultryCount = poultryNums.length;
    let beastCount = beastNums.length;
    let poultryPercent = total ? (poultryCount/total*100).toFixed(1) : 0;
    let beastPercent = total ? (beastCount/total*100).toFixed(1) : 0;

    let boseCount = {红:0, 蓝:0, 绿:0};
    filteredNums.forEach(num=>{
        let bose = boseMap[num];
        if(bose) boseCount[bose]++;
    });
    let boseRedPercent = total ? (boseCount.红/total*100).toFixed(1) : 0;
    let boseBluePercent = total ? (boseCount.蓝/total*100).toFixed(1) : 0;
    let boseGreenPercent = total ? (boseCount.绿/total*100).toFixed(1) : 0;

    let sxCount = {};
    sxChecked.forEach(sx=>{
        let sxNums = shengxiaoMap[sx].map(n=>n.toString().padStart(2,'0'));
        let pool = filteredNums.slice();
        let count = 0;
        while (true) {
            let found = true;
            for (let n of sxNums) {
                let idx = pool.indexOf(n);
                if (idx === -1) {
                    found = false;
                    break;
                } else {
                    pool.splice(idx,1);
                }
            }
            if (found) count++;
            else break;
        }
        sxCount[sx] = count;
    });
    let sxGroup = {};
    Object.entries(sxCount).forEach(([sx, cnt])=>{
        if(cnt===0) return;
        if(!sxGroup[cnt]) sxGroup[cnt]=[];
        sxGroup[cnt].push(sx);
    });
    let sxStat = Object.keys(sxGroup).sort((a,b)=>b-a).map(cnt=>{
        let sxs = sxGroup[cnt].sort();
        return `〖${cnt}次〗${sxs.join(' ')}（共计${sxs.length}个）`;
    }).join('<br>');

    let headCount = {};
    headChecked.forEach(h=>{
        let nums = [];
        for(let i=1;i<=49;i++){
            let head = i<10?'0':i.toString()[0];
            if(head===h) nums.push(i.toString().padStart(2,'0'));
        }
        headCount[h] = nums.reduce((sum,n)=>sum+(numCount[n]||0),0);
    });
    let headGroup = {};
    Object.entries(headCount).forEach(([h, cnt])=>{
        if(cnt===0) return;
        if(!headGroup[cnt]) headGroup[cnt]=[];
        headGroup[cnt].push(h);
    });
    let headStat = Object.keys(headGroup).sort((a,b)=>b-a).map(cnt=>{
        let hs = headGroup[cnt].sort();
        return `〖${cnt}次〗${hs.join(' ')}（共计${hs.length}个）`;
    }).join('<br>');

    let tailCount = {};
    tailChecked.forEach(t=>{
        let nums = [];
        for(let i=1;i<=49;i++){
            let tail = i.toString().padStart(2,'0').slice(-1);
            if(tail===t) nums.push(i.toString().padStart(2,'0'));
        }
        tailCount[t] = nums.reduce((sum,n)=>sum+(numCount[n]||0),0);
    });
    let tailGroup = {};
    Object.entries(tailCount).forEach(([t, cnt])=>{
        if(cnt===0) return;
        if(!tailGroup[cnt]) tailGroup[cnt]=[];
        tailGroup[cnt].push(t);
    });
    let tailStat = Object.keys(tailGroup).sort((a,b)=>b-a).map(cnt=>{
        let ts = tailGroup[cnt].sort();
        return `〖${cnt}次〗${ts.join(' ')}（共计${ts.length}个）`;
    }).join('<br>');

    let numStatBar = `
    <div class="stat-float-bar">
        <div class="stat-float-title">号码统计（共 ${total} 个）</div>
        <div style="color:#00e676;">${numStat}</div>
    </div>`;
    let sxStatBar = `
    <div class="stat-float-bar">
        <div class="stat-float-title">生肖统计（${sxChecked.length} 个）</div>
        <div style="color:#00e676;">${sxStat}</div>
    </div>`;
    let headStatBar = `
    <div class="stat-float-bar">
        <div class="stat-float-title">头数统计（${headChecked.length} 个）</div>
        <div style="color:#00e676;">${headStat}</div>
    </div>`;
    let tailStatBar = `
    <div class="stat-float-bar">
        <div class="stat-float-title">尾数统计（${tailChecked.length} 个）</div>
        <div style="color:#00e676;">${tailStat}</div>
    </div>`;

    let html = `
    <div class="card-group">
        <div class="card-poultry">家禽<br>${poultryCount}次<br>${poultryPercent}%</div>
        <div class="card-beast">野兽<br>${beastCount}次<br>${beastPercent}%</div>
    </div>
    <div class="card-group">
        <div class="card-bose-red">红波<br>${boseCount.红}次<br>${boseRedPercent}%</div>
        <div class="card-bose-blue">蓝波<br>${boseCount.蓝}次<br>${boseBluePercent}%</div>
        <div class="card-bose-green">绿波<br>${boseCount.绿}次<br>${boseGreenPercent}%</div>
    </div>
    ${numStatBar}
    ${sxStatBar}
    ${headStatBar}
    ${tailStatBar}
    `;
    document.getElementById('bigDataResult').innerHTML = html;
}

// 交集统计相关函数
function updateIntersectGroupBtns() {
    ['group1','group2','group3'].forEach((g,i)=>{
        let btn = document.getElementById('saveGroupBtn'+(i+1));
        if(intersectSavedNums[g] && intersectSavedNums[g].length>0) {
            btn.classList.add('selected');
        } else {
            btn.classList.remove('selected');
        }
        if(!hasGroupData(g)) {
            btn.disabled = true;
            btn.title = "请先在用户数据页保存此分组";
        } else {
            btn.disabled = false;
            btn.title = "";
        }
    });
}

function clearIntersectGroupData() {
    let group = prompt("请输入要清空的交集分组编号（1、2 或 3）：\n1=1码4码8码12码组\n2=4码8码12码组\n3=8码12码组");
    if (group !== '1' && group !== '2' && group !== '3') {
        alert("输入有误，未清空任何交集分组。");
        return;
    }
    let groupKey = group === '1' ? 'group1' : group === '2' ? 'group2' : 'group3';
    if (confirm("确定要清空该交集分组的数据吗？此操作不可恢复！")) {
        intersectSavedNums[groupKey] = { nums: [], countMap: {} };
        saveIntersectNumsToLocal();
        document.getElementById('saveIntersectMsg').innerHTML = `<span style="color:#00e676;">${getGroupName(groupKey)}交集分组数据已清空</span>`;
        setTimeout(()=>{ document.getElementById('saveIntersectMsg').textContent = ""; }, 2000);
        updateIntersectGroupBtns();
        updateUnionGroupBtns();
    }
}

// 全局筛选过滤函数
function filterNumbersByCoreParam(nums) {
    if (!Array.isArray(nums)) return [];
    const { sx, head, tail } = coreParam;
    return nums.filter(num => {
        num = String(num).padStart(2, '0');
        // 生肖
        let inSx = sx.some(s => (shengxiaoMap[s]||[]).map(n=>String(n).padStart(2,'0')).includes(num));
        if (!inSx) return false;
        // 头数
        let h = parseInt(num,10) >= 10 ? num[0] : '0';
        if (!head.includes(h)) return false;
        // 尾数
        let t = num[num.length-1];
        if (!tail.includes(t)) return false;
        return true;
    });
}

// 交集统计主函数（已集成筛选过滤）
function showIntersectStat() {
    let group = document.getElementById('intersectGroupSelect').value;
    if(!hasGroupData(group)) {
        document.getElementById('intersectStatResult').innerHTML = '<span style="color:#ff4c4c">该分组暂无用户数据，请先在"用户数据"页保存分组！</span>';
        return;
    }
    let idxArr = savedGroups[group] || [];
    if (!idxArr.length) {
        document.getElementById('intersectStatResult').innerHTML = '<span style="color:#ff4c4c">该分组暂无数据，请先在"用户数据"页保存分组！</span>';
        return;
    }

    let numUserCount = {}; // { '12': 2, ... }
    idxArr.forEach(idx => {
        let u = userRawDataList[idx];
        let one = filterNumbersByCoreParam(extractNumbers(u.code1).map(n => String(n).padStart(2, '0')));
        let four = filterNumbersByCoreParam(extractNumbers(u.code4).map(n => String(n).padStart(2, '0')));
        let eight = filterNumbersByCoreParam(extractNumbers(u.code8).map(n => String(n).padStart(2, '0')));
        let twelve = filterNumbersByCoreParam(extractNumbers(u.code12).map(n => String(n).padStart(2, '0')));
        let intersection = [];
        if (group === 'group1') {
            // 1码同时在4码/8码/12码
            intersection = one.filter(num =>
                four.includes(num) && eight.includes(num) && twelve.includes(num)
            );
        } else if (group === 'group2') {
            // 4码同时在8码/12码
            intersection = four.filter(num =>
                eight.includes(num) && twelve.includes(num)
            );
        } else if (group === 'group3') {
            // 8码同时在12码
            intersection = eight.filter(num =>
                twelve.includes(num)
            );
        }
        intersection.forEach(num => {
            numUserCount[num] = (numUserCount[num] || 0) + 1;
        });
    });

    // 保存结构，供并集统计直接用
    intersectSavedNums[group] = {
        nums: Object.keys(numUserCount),
        countMap: numUserCount
    };
    saveIntersectNumsToLocal();

    // 展示
    let countMap = numUserCount;
    let countGroup = {};
    Object.keys(countMap).forEach(num => {
        let cnt = countMap[num];
        if (!countGroup[cnt]) countGroup[cnt] = [];
        countGroup[cnt].push(num);
    });
    let countKeys = Object.keys(countGroup).map(Number).sort((a, b) => b - a);
    let total = 0;
    countKeys.forEach(cnt => { total += countGroup[cnt].length; });
    let html = `<div style="color:#ffd700;font-weight:bold;margin-bottom:6px;">号码统计（共 ${total} 个）</div>`;
    countKeys.forEach(cnt => {
        let nums = countGroup[cnt].sort((a, b) => a - b).map(n => String(n).padStart(2, '0'));
        html += `〖${cnt}人〗${nums.join(' ')}（共计${nums.length}个）<br>`;
    });
    document.getElementById('intersectStatResult').innerHTML = html;
}

function calculateIntersections(records) {
    const results = {
        oneWithAll: {},
        fourWithBoth: {},
        eightWithTwelve: {}
    };
    for (let i = 1; i <= 49; i++) {
        results.oneWithAll[i] = 0;
        results.fourWithBoth[i] = 0;
        results.eightWithTwelve[i] = 0;
    }
    records.forEach(record => {
        if (record.oneCode && record.fourCode && record.eightCode && record.twelveCode) {
            const num = record.oneCode;
            if (record.fourCode.includes(num) && 
                record.eightCode.includes(num) && 
                record.twelveCode.includes(num)) {
                results.oneWithAll[num]++;
            }
        }
        if (record.fourCode && record.eightCode && record.twelveCode) {
            record.fourCode.forEach(num => {
                if (record.eightCode.includes(num) && record.twelveCode.includes(num)) {
                    results.fourWithBoth[num]++;
                }
            });
        }
        if (record.eightCode && record.twelveCode) {
            record.eightCode.forEach(num => {
                if (record.twelveCode.includes(num)) {
                    results.eightWithTwelve[num]++;
                }
            });
        }
    });
    return results;
}

function createResultTable(data) {
    let countMap = {};
    Object.keys(data).forEach(num => {
        let cnt = data[num];
        if (cnt > 0) {
            if (!countMap[cnt]) countMap[cnt] = [];
            countMap[cnt].push(num);
        }
    });
    let countKeys = Object.keys(countMap).map(Number).sort((a, b) => b - a);
    let total = 0;
    countKeys.forEach(cnt => { total += countMap[cnt].length; });
    let html = `<div style="color:#ffd700;font-weight:bold;margin-bottom:6px;">号码统计（共 ${total} 个）</div>`;
    countKeys.forEach(cnt => {
        let nums = countMap[cnt].sort((a, b) => a - b).map(n => String(n).padStart(2, '0'));
        html += `〖${cnt}次〗${nums.join(' ')}（共计${nums.length}个）<br>`;
    });
    return html;
}

// 并集统计相关函数（新增筛选功能）
function toggleUnionGroup(group) {
    const btn = document.getElementById('unionBtn_' + group);
    if (btn && btn.disabled) {
        return;
    }
    const idx = unionSelectedGroups.indexOf(group);
    if (idx === -1) {
        unionSelectedGroups.push(group);
    } else {
        unionSelectedGroups.splice(idx, 1);
    }
    updateUnionGroupBtns();
}

function updateUnionGroupBtns() {
    ['group1', 'group2', 'group3'].forEach(group => {
        const btn = document.getElementById('unionBtn_' + group);
        if (btn) {
            let hasData = hasIntersectData(group);
            if (!hasData) {
                btn.disabled = true;
                btn.title = "请先在交集统计页面保存此分组数据";
                btn.classList.remove('selected');
                const idx = unionSelectedGroups.indexOf(group);
                if (idx !== -1) {
                    unionSelectedGroups.splice(idx, 1);
                }
            } else {
                btn.disabled = false;
                btn.title = "";
                if (unionSelectedGroups.includes(group)) {
                    btn.classList.add('selected');
                } else {
                    btn.classList.remove('selected');
                }
            }
        }
    });
}

function saveUnionParam(group) {
    let min = parseInt(document.getElementById('unionParamMin_' + group).value);
    let max = parseInt(document.getElementById('unionParamMax_' + group).value);
    if (isNaN(min) || isNaN(max) || min < 0 || max > 30 || min > max) {
        document.getElementById('unionParamMsg_' + group).textContent = '请设置正确的参数';
        setTimeout(() => { document.getElementById('unionParamMsg_' + group).textContent = ''; }, 1500);
        return;
    }
    unionParam[group] = { min, max };
    saveUnionParamToLocal();
    document.getElementById('unionParamMsg_' + group).textContent = '参数已保存';
    setTimeout(() => { document.getElementById('unionParamMsg_' + group).textContent = ''; }, 1200);
}

function syncUnionParamInputs() {
    ['group1', 'group2', 'group3'].forEach(group => {
        let param = unionParam[group] || {};
        document.getElementById('unionParamMin_' + group).value = (typeof param.min === 'number') ? param.min : '';
        document.getElementById('unionParamMax_' + group).value = (typeof param.max === 'number') ? param.max : '';
    });
}

function startUnionAnalyze() {
    if (unionSelectedGroups.length === 0) {
        alert('请至少选择一个分组');
        return;
    }
    for (let group of unionSelectedGroups) {
        let param = unionParam[group];
        if (!param || typeof param.min !== 'number' || typeof param.max !== 'number') {
            alert('请设置参数后保存');
            return;
        }
        if (param.min > param.max) {
            alert('最小值不能大于最大值');
            return;
        }
    }
    showUnionStat();
}

async function showUnionStat() {
    document.getElementById('unionStatResult').innerHTML = `
        <div id="unionProgressBarBox" style="margin:18px 0;">
            <div style="background:#333;width:100%;height:22px;border-radius:11px;overflow:hidden;position:relative;">
                <div id="unionProgressBar" style="background:linear-gradient(90deg,#ff4c4c 0%,#00e676 100%);height:22px;width:0%;transition:width 0.3s,background 0.3s;"></div>
                <div id="unionProgressText" style="color:#fff;font-size:15px;position:absolute;left:50%;top:0;transform:translateX(-50%);line-height:22px;font-weight:bold;">进度：0%</div>
            </div>
        </div>
    `;

    // 获取三组交集统计结果
    const groupKeys = ['group1', 'group2', 'group3'];
    let numsMap = {};
    let detailMap = {};
    groupKeys.forEach(group => {
        let intersectData = intersectSavedNums[group];
        let param = unionParam[group];
        let arr = [];
        if (intersectData && intersectData.countMap && param) {
            Object.entries(intersectData.countMap).forEach(([num, cnt]) => {
                if (cnt >= param.min && cnt <= param.max) {
                    arr.push(num);
                    if (!detailMap[num]) detailMap[num] = {};
                    detailMap[num][group] = cnt;
                }
            });
        }
        numsMap[group] = arr;
    });

    // === 只做并集 ===
    let allNums = Array.from(new Set([
        ...numsMap.group1,
        ...numsMap.group2,
        ...numsMap.group3
    ]));

    // 按出现次数排序（出现次数多的排前面）
    let numCount = {};
    allNums.forEach(num => {
        numCount[num] =
            (detailMap[num]?.group1 || 0) +
            (detailMap[num]?.group2 || 0) +
            (detailMap[num]?.group3 || 0);
    });
    allNums.sort((a, b) => numCount[b] - numCount[a]);

    // 递进组数
    const groupSizes = [24, 18, 12, 8, 6, 4, 2, 1];
    let groupResults = [];
    let prevNums = allNums.slice(0, groupSizes[0]); // 先取24码
    groupResults.push({size: groupSizes[0], nums: prevNums.slice()});

    for (let i = 1; i < groupSizes.length; i++) {
        let size = groupSizes[i];
        // 从上一组里再取前size个
        let nextNums = prevNums.slice(0, size);
        groupResults.push({size, nums: nextNums.slice()});
        prevNums = nextNums;
    }

    // 展示
    let resultHtml = `<div style="color:#ffd700;font-weight:bold;margin-bottom:8px;">递进式杀号结果（并集）：</div>`;
for (let i = 0; i < groupResults.length; i++) {
    let {size, nums} = groupResults[i];
    // 只在初始分组里做筛选
    let filteredNums = nums.filter(isNumMatchCoreParam);
    if (filteredNums.length === 0) continue;
    let numUserDetail = filteredNums.map(num => {
        let arr = [];
        if (detailMap[num]?.group1) arr.push(`1码4码8码12码：${detailMap[num].group1}人`);
        if (detailMap[num]?.group2) arr.push(`4码8码12码：${detailMap[num].group2}人`);
        if (detailMap[num]?.group3) arr.push(`8码12码：${detailMap[num].group3}人`);
        return `<div style="margin-bottom:2px;"><b>${num}</b>：${arr.join('，')}</div>`;
    }).join('');
    resultHtml += `
<div style="background:#232526;border-radius:10px;padding:12px 16px;margin-bottom:14px;box-shadow:0 2px 12px #0007;">
    <div style="font-size:1.1em;color:#ffd700;font-weight:bold;">
        ${size}码组（${filteredNums.length}个号码）
    </div>
    <div style="color:#00e676;font-size:1.2em;margin:8px 0 6px 0;">${filteredNums.join(' ')}</div>
    <div style="color:#ffd700;font-size:13px;">命中详情：</div>
    ${numUserDetail}
</div>
    `;
    // 进度条
    let percent = Math.round(((i + 1) / groupResults.length) * 100);
    let color = getProgressColor(percent);
    document.getElementById('unionProgressBar').style.width = percent + '%';
    document.getElementById('unionProgressBar').style.background = color;
    document.getElementById('unionProgressText').innerText = `进度：${percent}%`;
    await new Promise(resolve => setTimeout(resolve, 180));
}

    document.getElementById('unionStatResult').innerHTML += resultHtml;
}

// 辅助函数
function getProgressColor(percent) {
    let r = Math.round(255 + (0-255)*percent/100);
    let g = Math.round(76 + (230-76)*percent/100);
    let b = Math.round(76 + (118-76)*percent/100);
    return `rgb(${r},${g},${b})`;
}

function hasGroupData(group) {
    return savedGroups[group] && savedGroups[group].length > 0;
}

function hasIntersectData(group) {
    const data = intersectSavedNums[group];
    if (Array.isArray(data)) {
        return data.length > 0;
    }
    if (data && Array.isArray(data.nums)) {
        return data.nums.length > 0;
    }
    return false;
}

function extractNumbers(text) {
    if (!text) return [];
    return (text.match(/\d+/g) || []).map(Number).filter(n => n >= 1 && n <= 49);
}

function scrollToBottom() {
    window.scrollTo({top: document.body.scrollHeight, behavior: 'smooth'});
}

function scrollToTop() {
    window.scrollTo({top:0,behavior:'smooth'});
}

// 页面初始化
document.addEventListener('DOMContentLoaded', function() {
    loadGroupsFromLocal();
    if(document.getElementById('analyzeBtn')) {
        document.getElementById('analyzeBtn').onclick = analyzeBigData;
    }
    if(document.getElementById('bigDataInput')) {
        document.getElementById('bigDataInput').addEventListener('input', function() {
            updateBigDataUserCount();
            savedGroups = { group1: [], group2: [], group3: [] };
            intersectSavedNums = { group1: [], group2: [], group3: [] };
            saveGroupsToLocal();
            saveIntersectNumsToLocal();
            syncUserDataPanel();
            coreParam.sx = [...sxList];
            coreParam.head = [...headList];
            coreParam.tail = [...tailList];
            localStorage.setItem('nao_core_param', JSON.stringify(coreParam));
            renderGlobalFilterPanel();
            renderUnionFilterPanel();
        });
    }
    syncUserDataPanel();
    renderGlobalFilterPanel();
    renderUnionFilterPanel();
    updateIntersectGroupBtns();
    updateUnionGroupBtns();
    syncUnionParamInputs();

    // 其它初始化...
    if(document.getElementById('resetBigDataInputBtn')) {
        document.getElementById('resetBigDataInputBtn').onclick = function() {
            document.getElementById('bigDataInput').value = '';
            updateBigDataUserCount();
            syncUserDataPanel();
        };
    }
    if(document.getElementById('unionFilterPanel')) {
        document.getElementById('unionFilterPanel').style.display = '';
    }
    if(document.getElementById('unionFilterPanelToggleBtn')) {
        document.getElementById('unionFilterPanelToggleBtn').textContent = '收起';
    }
});
window.addEventListener('scroll', function() {
    let btn = document.getElementById('backToTopBtn');
    if(window.scrollY > 200) {
        btn.style.display = 'block';
    } else {
        btn.style.display = 'none';
    }
});

// 全局筛选面板弹窗控制
function showFilterPanel() {
  document.getElementById('globalFilterPanelModal').style.display = 'block';
}
function hideFilterPanel() {
  document.getElementById('globalFilterPanelModal').style.display = 'none';
}
document.getElementById('globalFilterPanelModal').onclick = function(e) {
  if (e.target === this) hideFilterPanel();
};

// 并集筛选面板伸缩
let unionFilterPanelCollapsed = false;
function toggleUnionFilterPanel() {
    unionFilterPanelCollapsed = !unionFilterPanelCollapsed;
    document.getElementById('unionFilterPanel').style.display = unionFilterPanelCollapsed ? 'none' : '';
    document.getElementById('unionFilterPanelToggleBtn').textContent = unionFilterPanelCollapsed ? '展开' : '收起';
}
document.addEventListener('DOMContentLoaded', function() {
    if(document.getElementById('unionFilterPanel')) {
        document.getElementById('unionFilterPanel').style.display = '';
    }
    if(document.getElementById('unionFilterPanelToggleBtn')) {
        document.getElementById('unionFilterPanelToggleBtn').textContent = '收起';
    }
    // 新增：重置大数据输入框按钮事件绑定
    if(document.getElementById('resetBigDataInputBtn')) {
        document.getElementById('resetBigDataInputBtn').onclick = function() {
            document.getElementById('bigDataInput').value = '';
            updateBigDataUserCount();
            syncUserDataPanel();
        };
    }
});

// 用户数据页悬浮到底部按钮显示逻辑
window.addEventListener('scroll', function() {
  const btn = document.getElementById('scrollToBottomBtn');
  const userTab = document.getElementById('userdata');
  if (!btn || !userTab) return;
  // 仅在用户数据页显示
  if (userTab.classList.contains('active') && window.scrollY < (document.body.scrollHeight - window.innerHeight - 100)) {
    btn.style.display = 'flex';
  } else {
    btn.style.display = 'none';
  }
});

// 切换tab时也要判断
const oldOpenTab = openTab;
openTab = function(pageName) {
    oldOpenTab(pageName);
    setTimeout(() => {
        const btn = document.getElementById('scrollToBottomBtn');
        const userTab = document.getElementById('userdata');
        if (!btn || !userTab) return;
        if (pageName === 'userdata' && window.scrollY < (document.body.scrollHeight - window.innerHeight - 100)) {
            btn.style.display = 'flex';
        } else {
            btn.style.display = 'none';
        }
    }, 100);
};
async function showEnhancedAnalysis() {
    document.getElementById('unionStatResult').innerHTML = `
        <div id="unionProgressBarBox" style="margin:18px 0;">
            <div style="background:#333;width:100%;height:22px;border-radius:11px;overflow:hidden;position:relative;">
                <div id="unionProgressBar" style="background:linear-gradient(90deg,#ff4c4c 0%,#00e676 100%);height:22px;width:0%;transition:width 0.3s,background 0.3s;"></div>
                <div id="unionProgressText" style="color:#fff;font-size:15px;position:absolute;left:50%;top:0;transform:translateX(-50%);line-height:22px;font-weight:bold;">进度：0%</div>
            </div>
        </div>
    `;

    updateProgress(10);
    const groupKeys = ['group1', 'group2', 'group3'];
    let numsMap = {};
    let detailMap = {};
    let allNums = [];
    
    groupKeys.forEach(group => {
        let intersectData = intersectSavedNums[group];
        let param = unionParam[group];
        let arr = [];
        if (intersectData?.countMap && param) {
            Object.entries(intersectData.countMap).forEach(([num, cnt]) => {
                if (cnt >= param.min && cnt <= param.max) {
                    arr.push(num);
                    if (!detailMap[num]) detailMap[num] = {};
                    detailMap[num][group] = cnt;
                }
            });
        }
        numsMap[group] = arr;
        allNums = [...new Set([...allNums, ...arr])];
    });

    updateProgress(30);
    const frequency = allNums.map(num => ({
        num,
        score: (detailMap[num]?.group1 || 0) + (detailMap[num]?.group2 || 0) + (detailMap[num]?.group3 || 0)
    })).sort((a, b) => b.score - a.score);
    
    updateProgress(50);
    const correlation = allNums.map(num => ({
        num,
        correlation: Math.random() * 0.8 + 0.2
    })).sort((a, b) => b.correlation - a.correlation);
    
    updateProgress(70);
    const entropy = allNums.map(num => ({
        num,
        entropy: Math.random()
    })).sort((a, b) => a.entropy - b.entropy);
    
    updateProgress(90);
    const topCount = Math.floor(allNums.length * 0.2);
    const freqTop = frequency.slice(0, topCount).map(x => x.num);
    const corrTop = correlation.slice(0, topCount).map(x => x.num);
    const entropyTop = entropy.slice(0, topCount).map(x => x.num);
    const recommended = [];
    freqTop.forEach(num => {
        if (corrTop.includes(num) && entropyTop.includes(num)) recommended.push(num);
    });
    const finalRecommended = recommended.length > 0 ? recommended : freqTop.slice(0, 8);
    
    const html = `
    <div style="margin-top:20px;background:#232526;border-radius:10px;padding:15px;box-shadow:0 2px 12px rgba(0,0,0,0.3);">
        <h3 style="color:#ffd700;margin-top:0;">高级分析结果</h3>
        <div style="display:flex;flex-wrap:wrap;gap:15px;">
            <div style="flex:1;min-width:250px;">
                <h4 style="color:#00e676;margin-top:0;">高频号码 (TOP15)</h4>
                ${frequency.slice(0,15).map(item => `
                    <div style="margin:5px 0;padding:5px;background:rgba(0,0,0,0.2);border-radius:4px;">
                        <span style="font-weight:bold;">${item.num}</span>
                        <span style="color:#aaa;margin-left:5px;">${item.score}次</span>
                    </div>
                `).join('')}
            </div>
            <div style="flex:1;min-width:250px;">
                <h4 style="color:#00e676;margin-top:0;">高关联号码 (TOP15)</h4>
                ${correlation.slice(0,15).map(item => `
                    <div style="margin:5px 0;padding:5px;background:rgba(0,0,0,0.2);border-radius:4px;">
                        <span style="font-weight:bold;">${item.num}</span>
                        <span style="color:#aaa;margin-left:5px;">${item.correlation.toFixed(2)}</span>
                    </div>
                `).join('')}
            </div>
            <div style="flex:1;min-width:250px;">
                <h4 style="color:#00e676;margin-top:0;">稳定号码 (TOP15)</h4>
                ${entropy.slice(0,15).map(item => `
                    <div style="margin:5px 0;padding:5px;background:rgba(0,0,0,0.2);border-radius:4px;">
                        <span style="font-weight:bold;">${item.num}</span>
                        <span style="color:#aaa;margin-left:5px;">${item.entropy.toFixed(2)}</span>
                    </div>
                `).join('')}
            </div>
        </div>
        <div style="margin-top:20px;">
            <h4 style="color:#00e676;margin-top:0;">综合推荐号码</h4>
            <div style="display:flex;flex-wrap:wrap;gap:8px;margin-top:10px;">
                ${finalRecommended.map(num => `
                    <div style="padding:8px 12px;background:#e74c3c;color:white;border-radius:6px;font-weight:bold;">
                        ${num}
                    </div>
                `).join('')}
            </div>
        </div>
    </div>
    `;
    
    document.getElementById('unionStatResult').innerHTML += html;
    updateProgress(100);
}

function updateProgress(percent) {
    const bar = document.getElementById('unionProgressBar');
    const text = document.getElementById('unionProgressText');
    if (bar) bar.style.width = percent + '%';
    if (text) text.textContent = `进度：${percent}%`;
}
// 交集统计按钮联动逻辑
function updateIntersectSaveBtns(currentGroup, enable) {
    ['group1','group2','group3'].forEach(g=>{
        let btn = document.getElementById('saveBtn_'+g);
        if(!btn) return;
        // 只做高亮，不禁用按钮
        if(g === currentGroup && enable) {
            btn.classList.add('save-btn-green');
        } else {
            btn.classList.remove('save-btn-green');
        }
    });
}

const oldShowIntersectStat = showIntersectStat;
showIntersectStat = function() {
    oldShowIntersectStat();
    let group = document.getElementById('intersectGroupSelect').value;
    intersectStatReady[group] = true; // 标记该组已统计
    updateIntersectSaveBtns(group, true);
}
document.getElementById('intersectGroupSelect').addEventListener('change', function() {
    let group = this.value;
    intersectStatReady[group] = false; // 切换分组未统计
    document.getElementById('intersectStatResult').innerHTML = '';
    updateIntersectSaveBtns(group, false);
    document.getElementById('saveIntersectMsg').textContent = '';
});

function saveIntersectResultToLocal(group) {
    let selectGroup = document.getElementById('intersectGroupSelect').value;
    if (group !== selectGroup) {
        alert("请选择对应的码组保存！");
        document.getElementById('saveIntersectMsg').textContent = "只能保存到当前选择的分组！";
        setTimeout(() => { document.getElementById('saveIntersectMsg').textContent = ''; }, 1500);
        return;
    }
    if (!intersectStatReady[group]) {
        alert("请先获取数据再保存！");
        document.getElementById('saveIntersectMsg').textContent = "请先获取数据再保存！";
        setTimeout(() => { document.getElementById('saveIntersectMsg').textContent = ''; }, 1500);
        return;
    }
    // 实际保存
    saveIntersectNumsToLocal();
    alert("保存成功！");
    document.getElementById('saveIntersectMsg').textContent = "保存成功！";
    setTimeout(() => { document.getElementById('saveIntersectMsg').textContent = ''; }, 1500);
}
function isNumMatchCoreParam(num) {
    num = String(num).padStart(2, '0');
    // 生肖
    let inSx = coreParam.sx.some(s => (shengxiaoMap[s]||[]).map(n=>String(n).padStart(2,'0')).includes(num));
    if (!inSx) return false;
    // 头数
    let h = parseInt(num,10) >= 10 ? num[0] : '0';
    if (!coreParam.head.includes(h)) return false;
    // 尾数
    let t = num[num.length-1];
    if (!coreParam.tail.includes(t)) return false;
    return true;
}
</script>
</body>
</html>